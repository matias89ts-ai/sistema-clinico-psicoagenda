<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin | psmtraslavina.cl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#0f172a] text-slate-100 p-8 min-h-screen">
    <div id="authContainer" class="max-w-md mx-auto mt-20 p-10 bg-slate-800 rounded-3xl shadow-2xl">
        <h1 class="text-2xl font-serif font-bold text-white mb-8 text-center uppercase tracking-widest">Acceso Privado</h1>
        <input type="email" id="adminEmail" placeholder="Email" class="w-full p-4 mb-4 bg-slate-700 rounded-xl outline-none">
        <input type="password" id="adminPass" placeholder="Contraseña" class="w-full p-4 mb-8 bg-slate-700 rounded-xl outline-none">
        <button id="loginBtn" class="w-full bg-emerald-600 py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-emerald-500 transition-all">Ingresar</button>
        <p id="errorMsg" class="text-red-400 mt-4 text-sm hidden text-center"></p>
    </div>

    <div id="adminPanel" class="hidden max-w-6xl mx-auto animate-fade-in">
        <header class="flex justify-between items-center mb-12">
            <div><h1 class="text-3xl font-bold text-white font-serif">Panel Clínico</h1><p class="text-slate-400 uppercase text-[10px] tracking-widest font-bold">psmtraslavina.cl</p></div>
            <div id="metricas" class="flex gap-4">
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 text-center min-w-[140px]">
                    <p class="text-[10px] uppercase text-slate-500 font-bold mb-1">Pacientes Totales</p>
                    <p id="countPacientes" class="text-3xl font-bold text-emerald-400">...</p>
                </div>
            </div>
        </header>
        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1"><h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="users" class="text-emerald-500"></i> Directorio</h2><div id="listaPacientes" class="space-y-3"></div></div>
            <div class="lg:col-span-2 bg-slate-800/50 rounded-3xl p-8 border border-slate-700 min-h-[500px]" id="detallePaciente">
                <div class="flex flex-col items-center justify-center h-full opacity-30 italic"><i data-lucide="user-check" class="w-20 h-20 mb-4"></i><p>Selecciona un paciente para ver la ficha clínica</p></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";
        
        const config = { apiKey: "AIzaSyCvDoXguIABAkbf9XtpFjuSANv5W5PN0Ac", authDomain: "psmtraslavina.firebaseapp.com", projectId: "psmtraslavina", storageBucket: "psmtraslavina.firebasestorage.app", messagingSenderId: "148977142597", appId: "1:148977142597:web:7c9374ff780fcf913ccc2c" };
        const app = initializeApp(config);
        const auth = getAuth(app);
        const functions = getFunctions(app, "southamerica-west1");
        const listarPacientes = httpsCallable(functions, "listarPacientes");
        const obtenerMetricas = httpsCallable(functions, "obtenerMetricas");

        document.getElementById("loginBtn").onclick = async () => {
            const email = document.getElementById("adminEmail").value;
            const pass = document.getElementById("adminPass").value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { 
                document.getElementById("errorMsg").innerText = "Credenciales inválidas";
                document.getElementById("errorMsg").classList.remove("hidden");
            }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById("authContainer").classList.add("hidden");
                document.getElementById("adminPanel").classList.remove("hidden");
                cargarDatos();
            }
        });

        async function cargarDatos() {
            try {
                const [p, m] = await Promise.all([listarPacientes(), obtenerMetricas()]);
                document.getElementById("countPacientes").innerText = m.data.pacientes;
                document.getElementById("listaPacientes").innerHTML = p.data.map(p => `
                    <button onclick="verPaciente('${p.id}')" class="w-full text-left p-5 bg-slate-800 border border-slate-700 rounded-2xl hover:border-emerald-500 transition-all group">
                        <p class="font-bold text-white group-hover:text-emerald-400">${p.nombre}</p>
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-1">${p.telefono}</p>
                    </button>
                `).join('');
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        window.verPaciente = (id) => {
            document.getElementById("detallePaciente").innerHTML = `
                <div class="flex justify-between items-start mb-10">
                    <div><h2 class="text-3xl font-bold font-serif">Ficha: ${id}</h2><p class="text-emerald-400 font-bold uppercase text-xs tracking-widest">Estado: Activo</p></div>
                    <button class="bg-slate-700 px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest">Nueva Nota</button>
                </div>
                <div class="space-y-4 text-slate-400 italic text-sm"><p>Cargando historial clínico con ID de teléfono...</p></div>
            `;
        }
    </script>
</body>
</html>
