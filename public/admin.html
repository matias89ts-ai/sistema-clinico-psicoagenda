<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Clínico | Ps. Traslaviña</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tab-active { border-bottom: 2px solid #2563eb; color: #1e3a8a; font-weight: 600; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #e2e8f0; }

        .mini-day { height: 32px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
        .mini-day:hover { background-color: #e2e8f0; }
        .mini-today { border: 1px solid #3b82f6; font-weight: bold; color: #3b82f6; }
        .mini-selected { background-color: #0f172a !important; color: white !important; font-weight: bold; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mini-has-event::after { content: ""; position: absolute; bottom: 3px; width: 4px; height: 4px; background: #10b981; border-radius: 50%; }
        
        .status-select { appearance: none; text-align-last: center; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 8px center; background-size: 12px; padding-right: 24px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* Estilos Inputs Ficha */
        .ficha-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 0.25rem; text-transform: uppercase; }
        .ficha-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem; color: #1e293b; transition: all 0.2s; }
        .ficha-input:focus { ring: 2px solid #3b82f6; border-color: #3b82f6; outline: none; }
        .ficha-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; height: 100%; }
        .ficha-header { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: #334155; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem; margin-bottom: 1rem; }
    </style>
<script src='https://www.google.com/recaptcha/api.js?render=6Lf5K2IsAAAAACN9E2Qn0HxwZ27Xvfkljq_qe6qG'></script><style>.grecaptcha-badge { visibility: visible !important; z-index: 9999; }</style></head>
<body class="text-slate-800 relative">

    <div id="loginOverlay" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="lock" class="w-8 h-8 text-blue-600"></i></div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Acceso Restringido</h2>
            <form onsubmit="checkLogin(event)" class="space-y-4 mt-6">
                <input type="password" id="adminPass" class="w-full border border-slate-300 rounded-lg px-4 py-3 text-center outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contraseña" autofocus>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg">Entrar</button>
            </form>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden">Contraseña incorrecta.</p>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <nav class="bg-[#0f172a] text-white shadow-md sticky top-0 z-50">
            <div class="max-w-[1400px] mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3"><div class="bg-emerald-500 p-1.5 rounded-md"><i data-lucide="activity" class="w-5 h-5 text-white"></i></div><span class="font-bold text-lg tracking-tight">Panel Clínico</span></div>
                <button onclick="logout()" class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-medium"><i data-lucide="log-out" class="w-4 h-4"></i> Salir</button>
            </div>
        </nav>

        <main class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 fade-in">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-6 mb-6">
                <div class="flex items-center gap-4">
                    <div class="h-14 w-14 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 border border-slate-200"><i data-lucide="user" class="w-7 h-7"></i></div>
                    <div><h1 class="text-xl font-bold text-slate-900 uppercase">Ps. Matías Traslaviña</h1><p class="text-xs font-bold text-slate-500 uppercase tracking-wide mt-0.5">Administrador</p></div>
                </div>
                <div class="flex gap-4">
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 w-28 text-center"><div class="text-2xl font-bold text-blue-600" id="countPacientes">--</div><div class="text-[10px] font-bold text-blue-400 uppercase">Pacientes</div></div>
                    <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3 w-28 text-center"><div class="text-2xl font-bold text-emerald-600" id="countCitas">--</div><div class="text-[10px] font-bold text-emerald-400 uppercase">Citas</div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- COLUMNA PRINCIPAL -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[750px]">
                    <div class="px-6 border-b border-slate-200 flex justify-between items-center bg-white sticky top-0 z-10 min-h-[60px]">
                        
                        <!-- Tabs -->
                        <div class="flex space-x-6" id="tabsContainer">
                            <button onclick="switchTab('sesiones')" id="tab-sesiones" class="tab-active py-4 text-sm transition-all focus:outline-none flex items-center gap-2"><i data-lucide="calendar-days" class="w-4 h-4"></i> Próximas Sesiones</button>
                            <button onclick="switchTab('pacientes')" id="tab-pacientes" class="tab-inactive py-4 text-sm transition-all focus:outline-none flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Base de Pacientes</button>
                        </div>
                        
                        <!-- Titulo Dinámico (Para Fichas) -->
                        <div id="headerFicha" class="hidden flex items-center gap-2">
                            <h2 class="font-bold text-slate-800 text-lg">Ficha de Salud Mental</h2>
                        </div>

                        <!-- Acciones -->
                        <div id="actions-sesiones" class="action-group"><button onclick="iniciarCargaDatos()" class="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-50 shadow-sm flex items-center gap-1 font-bold"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync</button></div>
                        <div id="actions-pacientes" class="action-group hidden flex gap-2"><button onclick="sincronizar()" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-200 border border-slate-300 font-bold" title="Importar"><i data-lucide="database" class="w-3 h-3"></i></button><button onclick="abrirModalPaciente()" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 flex items-center gap-1 font-bold"><i data-lucide="plus" class="w-3 h-3"></i> NUEVO</button></div>
                        <div id="actions-ficha" class="action-group hidden"><button onclick="cerrarFicha()" class="text-xs text-blue-600 hover:text-blue-800 font-bold flex items-center gap-1 border border-blue-200 px-3 py-1.5 rounded bg-blue-50"><i data-lucide="arrow-left" class="w-3 h-3"></i> Volver</button></div>
                        <div id="actions-ficha-completa" class="action-group hidden"><button onclick="cerrarFichaCompleta()" class="text-xs text-blue-600 hover:text-blue-800 font-bold flex items-center gap-1 border border-blue-200 px-3 py-1.5 rounded bg-blue-50"><i data-lucide="arrow-left" class="w-3 h-3"></i> Volver a Notas</button></div>
                    </div>

                    <!-- VISTA 1: AGENDA -->
                    <div id="content-sesiones" class="flex-1 overflow-y-auto custom-scroll relative fade-in"><table class="w-full text-left border-collapse"><thead class="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm"><tr class="text-[10px] uppercase tracking-wider font-bold"><th class="px-6 py-3">Fecha/Hora</th><th class="px-6 py-3">Paciente</th><th class="px-6 py-3 text-center">Estado</th><th class="px-6 py-3 text-right">Acciones</th></tr></thead><tbody id="listaCitas" class="divide-y divide-slate-50 text-sm"><tr><td colspan="4" class="p-10 text-center text-slate-400">Cargando...</td></tr></tbody></table></div>

                    <!-- VISTA 2: LISTA PACIENTES -->
                    <div id="content-pacientes" class="hidden flex-1 overflow-y-auto custom-scroll relative fade-in"><table class="w-full text-left border-collapse"><thead class="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm"><tr class="text-[10px] uppercase tracking-wider font-bold"><th class="px-6 py-3 w-1/2">Paciente / Motivo</th><th class="px-6 py-3">RUT</th><th class="px-6 py-3 text-right">Acciones</th></tr></thead><tbody id="listaPacientes" class="divide-y divide-slate-50 text-sm"><tr><td colspan="3" class="p-10 text-center text-slate-400">Cargando...</td></tr></tbody></table></div>

                    <!-- VISTA 3: FICHA RÁPIDA (HISTORIAL) -->
                    <div id="content-ficha" class="hidden flex-1 overflow-hidden flex flex-col fade-in bg-white">
                        <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                            <div>
                                <!-- CORREGIDO: Llamada sin parámetro, usa variable global -->
                                <h2 class="text-xl font-bold text-blue-800 hover:underline cursor-pointer flex items-center gap-2" onclick="abrirFichaCompleta()" title="Ver Ficha Completa">
                                    <span id="fichaNombre">Nombre</span> <i data-lucide="external-link" class="w-4 h-4"></i>
                                </h2>
                                <p class="text-xs text-slate-500" id="fichaEmail">email</p>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-[10px] font-bold bg-white text-slate-600 px-2 py-0.5 rounded border border-slate-200 uppercase" id="fichaRut">RUT</span>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-slate-50 space-y-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200"><h4 class="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="file-plus" class="w-3 h-3"></i> Nueva Nota Clínica</h4><textarea id="notaContenido" rows="3" class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Escribe la evolución..."></textarea><div class="flex justify-between items-center mt-3"><select id="notaTipo" class="text-xs border rounded p-1.5 text-slate-600 bg-slate-50"><option>Evolución</option><option>Anamnesis</option><option>Informe</option></select><button onclick="guardarNota()" class="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded hover:bg-blue-700 transition-colors">GUARDAR NOTA</button></div></div>
                            <div id="historialClinico" class="space-y-4"><div class="text-center text-slate-400 text-sm py-4">Cargando historial...</div></div>
                        </div>
                    </div>

                    <!-- VISTA 4: FICHA COMPLETA -->
                    <div id="content-ficha-completa" class="hidden flex-1 overflow-y-auto custom-scroll p-8 bg-slate-50 fade-in">
                        <form id="formFichaCompleta" onsubmit="guardarFichaCompleta(event)">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Tarjetas (Mismo código anterior) -->
                                <div class="ficha-card"><div class="ficha-header"><i data-lucide="fingerprint" class="w-5 h-5 text-blue-500"></i> Identificación</div><div class="space-y-3"><div><label class="ficha-label">Nombre Completo</label><input type="text" id="fcNombre" class="ficha-input" required></div><div><label class="ficha-label">RUT</label><input type="text" id="fcRut" class="ficha-input"></div><div><label class="ficha-label">Fecha Nacimiento</label><input type="date" id="fcNacimiento" class="ficha-input" onchange="calcEdad()"></div><div><label class="ficha-label">Edad</label><input type="text" id="fcEdad" class="ficha-input bg-slate-100" readonly></div><div><label class="ficha-label">Sexo</label><select id="fcSexo" class="ficha-input"><option value="">Seleccionar</option><option>Femenino</option><option>Masculino</option></select></div><div><label class="ficha-label">Género</label><input type="text" id="fcGenero" class="ficha-input"></div><div><label class="ficha-label">Previsión</label><input type="text" id="fcPrevision" class="ficha-input"></div><div><label class="ficha-label">Convenio</label><input type="text" id="fcConvenio" class="ficha-input"></div></div></div>
                                <div class="ficha-card"><div class="ficha-header"><i data-lucide="contact" class="w-5 h-5 text-blue-500"></i> Contacto y Situación</div><div class="space-y-3"><div><label class="ficha-label">Teléfono</label><input type="tel" id="fcCelular" class="ficha-input"></div><div><label class="ficha-label">Email</label><input type="email" id="fcEmail" class="ficha-input"></div><div><label class="ficha-label">Dirección</label><input type="text" id="fcDireccion" class="ficha-input"></div><div><label class="ficha-label">Ocupación</label><input type="text" id="fcOcupacion" class="ficha-input"></div><div><label class="ficha-label">Estado Civil</label><select id="fcEstadoCivil" class="ficha-input"><option value="">Seleccionar</option><option>Soltero/a</option><option>Casado/a</option><option>Viudo/a</option><option>Divorciado/a</option><option>Conviviente Civil</option></select></div></div></div>
                                <div class="ficha-card"><div class="ficha-header"><i data-lucide="ambulance" class="w-5 h-5 text-red-500"></i> Emergencia</div><div class="space-y-3"><div><label class="ficha-label">Nombre Contacto</label><input type="text" id="fcEmergenciaNombre" class="ficha-input"></div><div><label class="ficha-label">Teléfono</label><input type="tel" id="fcEmergenciaTel" class="ficha-input"></div><div><label class="ficha-label">Parentesco</label><input type="text" id="fcEmergenciaRelacion" class="ficha-input"></div><div><label class="ficha-label">CESFAM Inscrito</label><input type="text" id="fcCesfam" class="ficha-input"></div></div></div>
                            </div>
                            <div class="mt-8 flex justify-end"><button type="submit" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 shadow-lg flex items-center gap-2 transition-all"><i data-lucide="save" class="w-5 h-5"></i> GUARDAR FICHA</button></div>
                        </form>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col h-[750px]">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-100"><button onclick="miniCalChange(-1)" class="p-1 hover:bg-slate-100 rounded-full text-slate-500"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex items-center gap-2"><span class="text-sm font-bold text-slate-800 capitalize" id="currentMonthLabel">Mes</span><select id="yearSelect" onchange="changeYear(this.value)" class="text-sm font-bold text-blue-600 bg-transparent cursor-pointer outline-none hover:bg-blue-50 rounded px-1"></select></div><button onclick="miniCalChange(1)" class="p-1 hover:bg-slate-100 rounded-full text-slate-500"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                    <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-slate-400 uppercase mb-2"><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sa</div><div>Do</div></div>
                    <div id="miniCalendar" class="grid grid-cols-7 gap-1 mb-6"></div>
                    <div class="flex-1 border-t border-slate-100 pt-4 flex flex-col overflow-hidden"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex justify-between items-center">Agenda: <span id="selectedDateLabel" class="text-blue-600">Hoy</span></h3><div id="dayAgendaList" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales se mantienen igual -->
    <div id="modalPaciente" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl relative"><button onclick="cerrarModalPaciente()" class="absolute top-4 right-4 text-slate-400"><i data-lucide="x"></i></button><h3 class="text-lg font-bold text-slate-800 mb-4" id="pacienteModalTitle">Nuevo</h3><form id="formPaciente" class="space-y-3"><input type="hidden" id="pId"><div><label class="text-xs font-bold text-slate-500 uppercase">Nombre</label><input type="text" id="pNombre" class="w-full border rounded p-2 text-sm" required></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-500 uppercase">RUT</label><input type="text" id="pRut" class="w-full border rounded p-2 text-sm"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Celular</label><input type="tel" id="pCel" class="w-full border rounded p-2 text-sm" required></div></div><div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input type="email" id="pEmail" class="w-full border rounded p-2 text-sm" required></div><div><label class="text-xs font-bold text-slate-500 uppercase">Ciudad</label><input type="text" id="pCiudad" class="w-full border rounded p-2 text-sm"></div><div><label class="text-xs font-bold text-slate-500 uppercase">Motivo</label><input type="text" id="pMotivo" class="w-full border rounded p-2 text-sm" required></div><div class="mt-6 pt-4 border-t"><button type="submit" class="w-full py-2 bg-blue-600 text-white rounded text-sm font-bold">Guardar</button></div></form></div></div>
    <div id="editModal" class="hidden"></div> 

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";

        const firebaseConfig = { apiKey: "AIzaSyCvDoXguIABAkbf9XtpFjuSANv5W5PN0Ac", authDomain: "psmtraslavina.firebaseapp.com", projectId: "psmtraslavina", storageBucket: "psmtraslavina.firebasestorage.app", messagingSenderId: "148977142597", appId: "1:148977142597:web:7c9374ff780fcf913ccc2c" };
        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app, "southamerica-west1");
        
        // Referencias
        const listarCitas=httpsCallable(functions,"listarCitas"), listarPacientes=httpsCallable(functions,"listarPacientes"), crearPaciente=httpsCallable(functions,"crearPaciente"), editarPaciente=httpsCallable(functions,"editarPaciente"), eliminarPaciente=httpsCallable(functions,"eliminarPaciente"), obtenerMetricas=httpsCallable(functions,"obtenerMetricas"), obtenerDisponibilidadMes=httpsCallable(functions,"obtenerDisponibilidadMes"), cambiarEstadoCita=httpsCallable(functions,"cambiarEstadoCita"), anularCita=httpsCallable(functions,"anularCita"), solicitarReconfirmacion=httpsCallable(functions,"solicitarReconfirmacion"), modificarCita=httpsCallable(functions,"modificarCita");
        const agregarNotaClinica = httpsCallable(functions, "agregarNotaClinica"), obtenerHistorialClinico = httpsCallable(functions, "obtenerHistorialClinico");

        window.checkLogin=(e)=>{e.preventDefault();if(document.getElementById("adminPass").value==="psico2026"){sessionStorage.setItem("auth","ok");document.getElementById("loginOverlay").classList.add("hidden");document.getElementById("appContent").classList.remove("hidden");iniciarCargaDatos();}else document.getElementById("loginError").classList.remove("hidden");};
        if(sessionStorage.getItem("auth")==="ok"){document.getElementById("loginOverlay").classList.add("hidden");document.getElementById("appContent").classList.remove("hidden");setTimeout(iniciarCargaDatos,100);}
        window.logout=()=>{sessionStorage.removeItem("auth");window.location.reload();};

        let citasGlobal=[], pacientesGlobal=[], currentPatientId=null, miniCalDate=new Date(), selectedDateStr=null;

        window.iniciarCargaDatos = async () => {
            lucide.createIcons(); setupYearSelect();
            try { await Promise.all([cargarCitas(), cargarPacientes(), cargarMetricas()]); renderMiniCalendar(); renderDayDetails(new Date().toISOString().split("T")[0]); } 
            catch (e) { console.error(e); }
        };

        // --- NAVEGACIÓN Y VISTAS ---
        window.switchTab = (tab) => {
            document.querySelectorAll(".tab-active").forEach(e=>e.className="tab-inactive py-4 text-sm transition-all focus:outline-none flex items-center gap-2 cursor-pointer");
            if(document.getElementById("tab-"+tab)) document.getElementById("tab-"+tab).className="tab-active py-4 text-sm transition-all focus:outline-none flex items-center gap-2 cursor-pointer";
            document.querySelectorAll("[id^='content-']").forEach(c => c.classList.add("hidden"));
            document.getElementById("content-"+tab).classList.remove("hidden");
            document.querySelectorAll(".action-group").forEach(a => a.classList.add("hidden"));
            if(document.getElementById("actions-"+tab)) document.getElementById("actions-"+tab).classList.remove("hidden");
            if(tab === 'ficha' || tab === 'ficha-completa') {
                document.getElementById("tabsContainer").classList.add("hidden");
                document.getElementById("headerFicha").classList.remove("hidden");
            } else {
                document.getElementById("tabsContainer").classList.remove("hidden");
                document.getElementById("headerFicha").classList.add("hidden");
            }
        };

        // --- FICHA CLÍNICA ---
        window.abrirFicha = async (id) => {
            currentPatientId = id; const p = pacientesGlobal.find(x => x.id === id);
            document.getElementById("fichaNombre").innerText = p.nombre; document.getElementById("fichaEmail").innerText = p.email; document.getElementById("fichaRut").innerText = p.rut || "Sin RUT";
            switchTab("ficha"); 
            await cargarHistorial(id);
        };
        window.cerrarFicha = () => { currentPatientId = null; switchTab("pacientes"); };

        // --- FICHA COMPLETA ---
        // CORREGIDO: Llama a la variable global sin parámetro
        window.abrirFichaCompleta = () => {
            const id = currentPatientId; // Usar el ID que ya está en memoria
            const p = pacientesGlobal.find(x => x.id === id);
            if(!p) return;
            
            // Llenar Campos
            const setVal = (fid, val) => document.getElementById(fid).value = val || "";
            setVal("fcNombre", p.nombre); setVal("fcRut", p.rut); setVal("fcNacimiento", p.fechaNacimiento);
            setVal("fcSexo", p.sexo); setVal("fcGenero", p.genero); setVal("fcPrevision", p.prevision); setVal("fcConvenio", p.convenio);
            setVal("fcCelular", p.celular); setVal("fcEmail", p.email); setVal("fcDireccion", p.direccion); setVal("fcOcupacion", p.ocupacion); setVal("fcEstadoCivil", p.estadoCivil);
            setVal("fcEmergenciaNombre", p.emergenciaNombre); setVal("fcEmergenciaTel", p.emergenciaTel); setVal("fcEmergenciaRelacion", p.emergenciaRelacion); setVal("fcCesfam", p.cesfam);
            
            window.calcEdad();
            switchTab("ficha-completa");
        };
        window.cerrarFichaCompleta = () => { switchTab("ficha"); };

        window.calcEdad = () => {
            const nac = document.getElementById("fcNacimiento").value;
            if(!nac) { document.getElementById("fcEdad").value = ""; return; }
            const diff = Date.now() - new Date(nac).getTime();
            const age = new Date(diff).getUTCFullYear() - 1970;
            document.getElementById("fcEdad").value = Math.abs(age) + " años";
        };

        window.guardarFichaCompleta = async (e) => {
            e.preventDefault();
            const getVal = (fid) => document.getElementById(fid).value;
            const data = {
                id: currentPatientId,
                nombre: getVal("fcNombre"), rut: getVal("fcRut"), fechaNacimiento: getVal("fcNacimiento"),
                sexo: getVal("fcSexo"), genero: getVal("fcGenero"), prevision: getVal("fcPrevision"), convenio: getVal("fcConvenio"),
                celular: getVal("fcCelular"), email: getVal("fcEmail"), direccion: getVal("fcDireccion"), ocupacion: getVal("fcOcupacion"), estadoCivil: getVal("fcEstadoCivil"),
                emergenciaNombre: getVal("fcEmergenciaNombre"), emergenciaTel: getVal("fcEmergenciaTel"), emergenciaRelacion: getVal("fcEmergenciaRelacion"), cesfam: getVal("fcCesfam")
            };
            const btn = e.target.querySelector("button"); const txt = btn.innerHTML; btn.innerHTML = "Guardando..."; btn.disabled = true;
            try { await editarPaciente(data); alert("✅ Ficha actualizada."); cargarPacientes(); } catch(err) { alert(err.message); } finally { btn.innerHTML = txt; btn.disabled = false; }
        };

        // --- CARGADORES ---
        window.cargarCitas=async()=>{ try{const r=await listarCitas();citasGlobal=r.data;citasGlobal.sort((a,b)=>new Date(a.fecha+"T"+a.hora)-new Date(b.fecha+"T"+b.hora));renderTablaCitas();renderMiniCalendar();}catch(e){console.error(e);} };
        window.cargarPacientes=async()=>{ try{const r=await listarPacientes();pacientesGlobal=r.data;renderTablaPacientes();}catch(e){console.error(e);} };
        async function cargarMetricas(){try{const r=await obtenerMetricas();document.getElementById("countPacientes").innerText=r.data.pacientes;document.getElementById("countCitas").innerText=r.data.citas;}catch(e){}}

        // (Resto de funciones: renderTablaPacientes, renderTablaCitas, historial, modales, etc... IGUAL AL ANTERIOR)
        // Incluyo las básicas para que no falle al copiar
        async function cargarHistorial(id) {
            const container = document.getElementById("historialClinico");
            container.innerHTML = `<div class="text-center text-slate-400 py-4">Cargando...</div>`;
            try {
                const res = await obtenerHistorialClinico({ idPaciente: id });
                const notas = res.data;
                if (notas.length === 0) { container.innerHTML = `<div class="text-center text-slate-300 py-10 italic">No hay notas.</div>`; return; }
                container.innerHTML = notas.map(n => `<div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm"><div class="flex justify-between mb-2"><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">${n.tipo}</span><span class="text-xs text-slate-400 font-mono">${new Date(n.created||Date.now()).toLocaleDateString("es-CL")}</span></div><p class="text-sm text-slate-700 whitespace-pre-wrap">${n.contenido}</p></div>`).join("");
            } catch (e) { container.innerHTML = "Error."; }
        }
        window.guardarNota=async()=>{const c=document.getElementById("notaContenido").value;const t=document.getElementById("notaTipo").value;if(!c.trim())return;try{await agregarNotaClinica({idPaciente:currentPatientId,contenido:c,tipo:t});document.getElementById("notaContenido").value="";await cargarHistorial(currentPatientId);}catch(e){alert(e.message)}};

        function renderTablaPacientes() {
            const tbody = document.getElementById("listaPacientes");
            if(pacientesGlobal.length===0) { tbody.innerHTML=`<tr><td colspan="3" class="p-10 text-center text-slate-400">Sin pacientes.</td></tr>`; return; }
            tbody.innerHTML = pacientesGlobal.map(p => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 cursor-pointer" onclick="abrirFicha('${p.id}')">
                    <td class="px-6 py-4 align-top"><div class="font-bold text-slate-800 text-sm hover:text-blue-600 transition-colors">${p.nombre}</div><div class="text-xs text-slate-500">${p.email}</div><div class="text-[11px] text-slate-400 uppercase mt-1">${p.ciudad||"Web"} <span class="text-slate-300 mx-1">|</span> <span class="text-blue-500 font-semibold">${p.motivo_consulta||"Consulta"}</span></div></td>
                    <td class="px-6 py-4 text-sm font-mono text-slate-600">${p.rut||"--"}</td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2" onclick="event.stopPropagation()">
                        <button onclick="prepararEdicionPaciente('${p.id}')" class="p-1.5 text-blue-600 bg-blue-50 rounded border border-blue-200"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="borrarPaciente('${p.id}')" class="p-1.5 text-red-600 bg-red-50 rounded border border-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join("");
            lucide.createIcons();
        }
        function renderTablaCitas() {const tbody=document.getElementById("listaCitas");if(citasGlobal.length===0){tbody.innerHTML=`<tr><td colspan="4" class="p-10 text-center text-slate-400">Sin citas.</td></tr>`;return;}const es={"confirmada":"Confirmada","reconfirmada":"Re-confirmada","atendido":"Atendido","cancelado":"Cancelado","no_asiste":"No Asiste"};const cl={"confirmada":"bg-blue-50 text-blue-700","reconfirmada":"bg-emerald-50 text-emerald-700","atendido":"bg-slate-100 text-slate-600","cancelado":"bg-red-50 text-red-500","no_asiste":"bg-orange-50 text-orange-600"};tbody.innerHTML=citasGlobal.map(c=>{const[y,m,d]=c.fecha.split("-");const cs=cl[c.estado]||"bg-gray-100";const op=Object.entries(es).map(([k,v])=>`<option value="${k}" ${c.estado===k?"selected":""}>${v}</option>`).join("");return`<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50"><td class="px-6 py-4"><div class="font-mono text-slate-500 text-xs">${d}-${m}-${y}</div><div class="font-bold text-slate-800 text-base">${c.hora} hrs</div></td><td class="px-6 py-4"><div class="font-bold text-slate-700 text-sm">${c.nombre}</div><div class="text-xs text-slate-400">${c.email}</div></td><td class="px-6 py-4 text-center"><select onchange="cambiarEstado('${c.id}', this.value)" class="status-select text-[10px] font-bold uppercase rounded-full px-2 py-1 border-none cursor-pointer outline-none ${cs} w-full">${op}</select></td><td class="px-6 py-4 text-right flex justify-end gap-1"><button onclick="pedirConfirmacion('${c.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded" title="Reenviar Mail"><i data-lucide="mail" class="w-4 h-4"></i></button><button onclick="borrarCita('${c.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`}).join("");lucide.createIcons();}

        window.cambiarEstado=async(id,v)=>{try{await cambiarEstadoCita({idCita:id,nuevoEstado:v});cargarCitas();}catch(e){alert(e.message)}};window.borrarCita=async(id)=>{if(confirm("¿Borrar?"))try{await anularCita({idCita:id});cargarCitas();}catch(e){alert(e.message)}};window.pedirConfirmacion=async(id)=>{if(confirm("¿Reenviar?"))try{await solicitarReconfirmacion({idCita:id});alert("Enviado.");}catch(e){alert(e.message)}};window.borrarPaciente=async(id)=>{if(confirm("⚠️ Eliminar?"))try{await eliminarPaciente({id});cargarPacientes();}catch(e){alert(e.message)}};window.sincronizar=async()=>{if(confirm("Sync?")){await migrarPacientesHistoricos();cargarPacientes()}};
        
        window.abrirModalPaciente=()=>{document.getElementById("formPaciente").reset();document.getElementById("pId").value="";document.getElementById("modalTitle").innerText="Nuevo Paciente";document.getElementById("modalPaciente").classList.remove("hidden")};window.prepararEdicionPaciente=(id)=>{const p=pacientesGlobal.find(x=>x.id===id);if(!p)return;document.getElementById("pId").value=p.id;document.getElementById("pNombre").value=p.nombre;document.getElementById("pEmail").value=p.email;document.getElementById("pRut").value=p.rut||"";document.getElementById("pCel").value=p.celular;document.getElementById("pCiudad").value=p.ciudad||"";document.getElementById("pMotivo").value=p.motivo_consulta||"";document.getElementById("modalTitle").innerText="Editar Paciente";document.getElementById("modalPaciente").classList.remove("hidden")};window.cerrarModalPaciente=()=>{document.getElementById("modalPaciente").classList.add("hidden")};document.getElementById("formPaciente").addEventListener("submit",async(e)=>{e.preventDefault();const b=e.target.querySelector("button[type=submit]");b.innerText="...";b.disabled=true;const d={nombre:document.getElementById("pNombre").value,email:document.getElementById("pEmail").value,rut:document.getElementById("pRut").value,celular:document.getElementById("pCel").value,ciudad:document.getElementById("pCiudad").value,motivo_consulta:document.getElementById("pMotivo").value};try{if(document.getElementById("pId").value)await editarPaciente({id:document.getElementById("pId").value,...d});else await crearPaciente(d);cerrarModalPaciente();cargarPacientes();}catch(er){alert(er.message)}finally{b.innerText="Guardar";b.disabled=false}});
        
        function setupYearSelect(){const s=document.getElementById("yearSelect");const y=new Date().getFullYear();for(let i=y-1;i<=y+3;i++){const o=document.createElement("option");o.value=i;o.innerText=i;if(i===y)o.selected=true;s.appendChild(o);}s.onchange=(e)=>{miniCalDate.setFullYear(e.target.value);renderMiniCalendar()};}window.miniCalChange=(d)=>{miniCalDate.setMonth(miniCalDate.getMonth()+d);renderMiniCalendar()};function renderMiniCalendar(){const g=document.getElementById("miniCalendar");g.innerHTML="";const y=miniCalDate.getFullYear(),m=miniCalDate.getMonth();document.getElementById("currentMonthLabel").innerText=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][m];const bd=new Set(citasGlobal.filter(c=>c.estado!=="cancelado").map(c=>c.fecha));const fd=(new Date(y,m,1).getDay()+6)%7,dim=new Date(y,m+1,0).getDate(),ts=new Date().toISOString().split("T")[0];for(let i=0;i<fd;i++)g.appendChild(document.createElement("div"));for(let d=1;d<=dim;d++){const ds=`${y}-${(m+1).toString().padStart(2,"0")}-${d.toString().padStart(2,"0")}`;const div=document.createElement("div");div.className="mini-day text-slate-600";div.innerText=d;if(ds===ts)div.classList.add("mini-today");if(bd.has(ds))div.classList.add("mini-has-event");if(ds===selectedDateStr)div.classList.add("mini-selected");div.onclick=()=>{selectedDateStr=ds;renderMiniCalendar();renderDayDetails(ds)};g.appendChild(div);}}function renderDayDetails(ds){const c=document.getElementById("dayAgendaList");const[y,m,d]=ds.split("-");document.getElementById("selectedDateLabel").innerText=`${d}/${m}/${y}`;const cd=citasGlobal.filter(c=>c.fecha===ds&&c.estado!=="cancelado");cd.sort((a,b)=>a.hora.localeCompare(b.hora));c.innerHTML=cd.length===0?`<div class="text-center py-8 text-slate-400 text-xs">Libre.</div>`:cd.map(c=>`<div class="bg-slate-50 border border-slate-100 rounded-lg p-2 flex gap-3 mb-2"><div class="text-center w-10"><div class="text-xs font-bold text-slate-800">${c.hora}</div></div><div class="flex-1 overflow-hidden"><div class="text-xs font-bold text-slate-700 truncate">${c.nombre}</div></div></div>`).join("");}

        init();
    </script>
    <footer class="bg-[#0f172a] text-slate-500 py-8 text-center text-[10px] mt-auto uppercase tracking-widest"><p>© 2026, Hecho con ♥ por Matías Traslaviña Santana.</p></footer>
    <footer class="bg-[#0f172a] text-slate-500 py-8 text-center text-[10px] mt-auto uppercase tracking-widest"><p>© 2026, Hecho con ♥ por Matías Traslaviña Santana.</p></footer>
</body>
</html>




